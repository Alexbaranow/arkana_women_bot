# Режим разработки (Development)

Документ описывает всё, что нужно для **проверки UI веб-приложения из браузера** без запуска бота в Telegram.

---

## Зачем нужен режим разработки

- Открывать веб-приложение по `http://localhost:3000` в браузере (а не внутри Telegram WebView).
- Вызывать API без валидных Telegram `initData`: запросы идут от «виртуального» пользователя с id из `.env`.
- Не запускать бота: достаточно только API (карта дня, натальная карта, бесплатный вопрос и т.д.).

---

## Как запустить

1. **Терминал 1 — только API (без бота):**

   ```bash
   npm run dev:api
   ```

   Запускается `dev-api.js` → поднимается Express API на порту **3001**, читает `.env` из корня проекта.

2. **Терминал 2 — фронт:**

   ```bash
   npm run webapp
   ```

   Vite на **3000**, проксирует запросы с пути `/api` на `http://localhost:3001`.

3. Открыть в браузере: **http://localhost:3000**.

---

## Переменные окружения (режим разработки)

В корне проекта файл **`.env`** (не коммитить секреты).

| Переменная       | Обязательно в dev                  | Назначение                                                                                                                      |
| ---------------- | ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| `NODE_ENV`       | Нет                                | Если не `production` — включён режим разработки в API (см. ниже). По умолчанию при `npm run dev:api` не задана → считается dev. |
| `DEV_USER_ID`    | Да (рекомендуется)                 | «Виртуальный» Telegram user id для запросов без initData. Число, например `123456789`.                                          |
| `ADMIN_ID`       | Нет                                | Используется как fallback для `DEV_USER_ID`, если тот не задан.                                                                 |
| `API_PORT`       | Нет                                | Порт API. По умолчанию **3001** (должен совпадать с proxy в Vite).                                                              |
| `BOT_TOKEN`      | Нет                                | В dev без него API всё равно отвечает: авторизация подменяется на `DEV_USER_ID`. Для оплаты Stars нужен.                        |
| `BOTHUB_API_KEY` | Альтернатива OpenAI                | JWT-ключ BotHub (bothub.chat), модель по умолчанию Grok 4.1 Fast.                                                               |
| `OPENAI_API_KEY` | Да (для карты дня/натальной карты) | Ключ OpenAI (или иного провайдера через `OPENAI_BASE_URL`). Нужен один из: BOTHUB_API_KEY или OPENAI_API_KEY.                   |

Для веб-приложения (Vite) в dev обычно **не** задают `VITE_API_URL` (или оставляют пустым): запросы идут на относительный `/api` и проксируются на 3001.

---

## Где в коде используется режим разработки

### 1. `api.js`

- **Константы в начале файла (блок «DEV»):**

  - `isDev` — `process.env.NODE_ENV !== "production"`.
  - `DEV_USER_ID` — из `process.env.DEV_USER_ID` или `process.env.ADMIN_ID`, иначе `0`.

- **`getUserIdFromInitData(initData, res)`**  
  **Где:** вызывается во всех маршрутах, требующих пользователя (карта дня, оплата, заказы, бесплатный вопрос и т.д.).  
  **В dev:** если `isDev` и (нет `initData` или нет `BOT_TOKEN`), возвращает `DEV_USER_ID || 1` и **не** отправляет 400/401.  
  **Зачем:** в браузере нет Telegram → нет initData; без этого все запросы падали бы с «Нужны initData».

- **`validateNatalRequest(req, res)`**  
  **Где:** маршруты `POST /api/calculate-ascendant` и `POST /api/calculate-natal-chart`.  
  **В dev:** при `isDev` **пропускается** проверка initData и BOT_TOKEN.  
  **Зачем:** расчёт асцендента и натальной карты из личного кабинета можно вызывать из браузера без Telegram.

- **Ответы об ошибках (500)**  
  **Где:** карта дня (create/get), глобальный обработчик ошибок Express.  
  **В dev:** в JSON добавляется поле `serverError` с текстом ошибки.  
  **Зачем:** удобнее отлаживать в UI/консоли.

- **Логирование**  
  **Где:** `POST /api/card-of-the-day/get`.  
  **В dev:** в консоль выводится, есть ли в запросе initData.  
  **Зачем:** отладка авторизации.

### 2. `dev-api.js`

- **Назначение:** точка входа «только API, без бота» для локальной разработки.
- **Что делает:** подгружает `.env`, вызывает `createApiServer(port, null)` (bot = null).
- **Запуск:** `npm run dev:api` (см. `package.json` → скрипт `"dev:api": "node dev-api.js"`).

### 3. `webapp/vite.config.js`

- **Proxy:** запросы с пути `/api` уходят на `http://localhost:3001`.
- **Зачем:** при открытии приложения на `http://localhost:3000` все вызовы `fetch("/api/...")` идут на локальный API без CORS и без указания полного URL.

### 4. Веб-приложение (переменные Vite)

- **`VITE_API_URL`** — в dev обычно пустая строка или не задана: базовый URL для запросов тогда пустой, запросы относительные (`/api/...`) и уходят в proxy.
- **`VITE_BOT_USERNAME`** — опционально; для кнопки «Открыть в Telegram» в Checkout (в dev можно не задавать).

---

## Краткая схема

```
Браузер (localhost:3000)
    → fetch("/api/...")
    → Vite proxy
    → localhost:3001 (dev-api / createApiServer)
    → api.js: isDev === true
    → без initData возвращается userId = DEV_USER_ID || 1
    → маршруты работают под «виртуальным» пользователем
```

В production (`NODE_ENV=production`, например в Docker) `isDev` будет `false`: подмена userId отключена, initData обязательны.
